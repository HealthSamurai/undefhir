terminology: true  

dictionary:
  - name: Patient
    json: test/resources/Patient1.json

  - name: FamilyDict
    json: test/resources/dictionary/color.json 

  - name: GivenDict
    file: test/resources/dictionary/names

  - name: CountryDict
    json: test/resources/dictionary/color.json 

  - name: CityDict
    json: test/resources/dictionary/color.json 

  - name: StateDict
    json: test/resources/dictionary/color.json 

  - name: DistrictDict 
    json: test/resources/dictionary/color.json 

  - name: LineDict 
    json: test/resources/dictionary/color.json 

  - name: CodeSystems
    query: |
      select cs.resource->>'name' as system, jsonb_agg(c.resource) as entry
      from concept c
      join codesystem as cs
      on cs.resource->>'url' = c.resource->>'system'
      group by cs.id

fns:
  - name: mkName 
    $fn: [s]
    $body: $ last (split(s, "/"))

  - name: cleanUpConcept
    $fn: [concept]
    $body:
      $map: $ concept
      $as: c
      $body:
        code: $ c.code
        display: $ c.display

  - name: saveFile 
    $fn: [sys, cnt]
    $body:
      $call: spit
      $args:
        - $ "/home/victor/Documents/Alkona/undefhir/resources/fhir-term/" + fns.mkName(toString(sys)) + ".yaml" 
        - $  fns.toYaml(fns.cleanUpConcept(cnt)) 
    
  - name: intoFiles
    $body:
      $map: $ fns.dict("CodeSystems") 
      $as: i 
      $body:
        $ fns.saveFile (i.system, i.entry)

  - name: testPatient
    $body:
      name: $ fns.randHumanName (get(fns.dict("Patient"), "name"))
      telecom: $ fns.randContactPoint(get(fns.dict("Patient"), "telecom"))
      address: $ fns.randAddress(get(fns.dict("Patient"), "address"))
      birthDate: $ fns.randBirthDate()

